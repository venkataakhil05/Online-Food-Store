<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Rathna Foods</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600&family=Playfair+Display:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Admin Specific Overrides for Luxury Feel */
        body {
            /* Inherits background from styles.css */
            min-height: 100vh;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            animation: fadeInUp 0.8s ease-out;
        }

        /* Glass Header */
        header {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px;
            margin-bottom: 3rem;
            box-shadow: var(--shadow-soft);
        }

        h1 {
            font-family: var(--font-heading);
            font-size: 2rem;
            color: var(--gold-primary);
            letter-spacing: 1px;
            margin: 0;
        }

        .shop-link {
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
            border: 1px solid var(--glass-border);
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }

        .shop-link:hover {
            color: var(--gold-primary);
            border-color: var(--gold-primary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 1rem;
        }

        .tab-btn {
            background: transparent;
            color: var(--text-muted);
            padding: 0.8rem 2rem;
            border: none;
            font-family: var(--font-heading);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .tab-btn.active {
            color: var(--gold-primary);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1.1rem;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--gold-primary);
            box-shadow: 0 0 10px var(--gold-primary);
        }

        .panel {
            display: none;
        }

        .panel.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        /* Inventory Table - Glass Style */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: var(--text-main);
        }

        th {
            background: rgba(0, 0, 0, 0.3);
            text-align: left;
            padding: 1.2rem;
            font-family: var(--font-heading);
            color: var(--gold-light);
            font-weight: 600;
            border-bottom: 1px solid var(--glass-border);
        }

        td {
            padding: 1.2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-family: var(--font-body);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Inputs in Table */
        input[type="number"],
        input[type="text"],
        select {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 0.5rem;
            border-radius: 6px;
            width: 100%;
            font-family: var(--font-body);
        }

        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--gold-primary);
        }

        /* Fix for Select Options (Dropdown text visibility) */
        select option {
            background-color: #222;
            color: white;
            padding: 10px;
        }

        /* Action Buttons */
        .action-btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            border: none;
            transition: all 0.3s;
        }

        .save-btn {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .save-btn:hover {
            background: rgba(16, 185, 129, 0.4);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
        }

        .delete-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.4);
            margin-left: 0.5rem;
        }

        .delete-btn:hover {
            background: rgba(239, 68, 68, 0.4);
        }

        .add-new-btn {
            display: inline-block;
            background: var(--gold-primary);
            color: black;
            font-weight: 700;
            padding: 0.8rem 1.5rem;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }

        .add-new-btn:hover {
            transform: translateY(-2px);
            background: #f3e5ab;
        }

        /* Orders List */
        .order-card {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid var(--gold-primary);
            transition: all 0.3s;
        }

        .order-card:hover {
            transform: translateX(5px);
            border-color: var(--gold-primary);
        }

        .order-card.confirmed {
            border-left-color: var(--primary-green);
        }

        .order-card.refunded {
            border-left-color: #ef4444;
            opacity: 0.6;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
            font-family: var(--font-heading);
            color: var(--gold-light);
        }

        .order-details h4 {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-badge.pending {
            background: rgba(212, 175, 55, 0.2);
            color: var(--gold-primary);
        }

        .status-badge.confirmed {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .status-badge.refunded {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        /* Login Overlay */
        #admin-login-overlay {
            background: var(--bg-dark) !important;
            backdrop-filter: blur(20px);
        }

        .login-box {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid var(--glass-border);
            padding: 3rem;
            border-radius: 16px;
            width: 400px;
            text-align: center;
            box-shadow: var(--shadow-soft);
        }

        .login-box h2 {
            font-family: var(--font-heading);
            color: var(--gold-primary);
            margin-bottom: 2rem;
        }

        .login-input {
            width: 100%;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: white;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            background: var(--gold-primary);
            color: black;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }

        .login-btn:hover {
            background: #f3e5ab;
        }

        /* Modal */
        .modal-content {
            background: #111 !important;
            border: 1px solid var(--gold-primary);
            color: white;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* --- MOBILE RESPONSIVE CARD LAYOUT --- */
        @media (max-width: 768px) {
            .admin-container {
                padding: 1rem;
            }

            header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
                margin-bottom: 2rem;
            }

            .tabs {
                overflow-x: auto;
                padding-bottom: 5px;
                /* Hide scrollbar visually but allow scroll */
                -ms-overflow-style: none;
                /* IE and Edge */
                scrollbar-width: none;
                /* Firefox */
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab-btn {
                white-space: nowrap;
                padding: 0.8rem 1rem;
                font-size: 1rem;
            }

            /* HIDE THE TABLE HEADERS */
            thead {
                display: none;
            }

            /* TABLE ROWS AS CARDS */
            tbody,
            tr,
            td {
                display: block;
                width: 100%;
            }

            tr {
                background: var(--bg-card);
                border: 1px solid var(--glass-border);
                margin-bottom: 1.5rem;
                border-radius: 12px;
                padding: 1rem;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
                position: relative;
            }

            /* CELLS */
            td {
                padding: 0.5rem 0;
                border-bottom: none;
                text-align: left;
            }

            /* SPECIFIC CELL STYLING */

            /* 1. Item Info (Image + Name) */
            td:nth-child(1)>div {
                flex-direction: row;
                align-items: flex-start;
            }

            /* 2. Category Badge - Position absolute top right */
            td:nth-child(2) {
                position: absolute;
                top: 1rem;
                right: 1rem;
                width: auto;
                padding: 0;
            }

            /* 3. Stock Input */
            td:nth-child(3) {
                margin-top: 1rem;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                padding-top: 1rem;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            td:nth-child(3)::before {
                content: 'Stock:';
                color: var(--text-muted);
                font-size: 0.9rem;
            }

            /* 4. Actions - Grid Layout */
            td:nth-child(4) {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                /* 3 Buttons equal width */
                gap: 10px;
                margin-top: 1rem;
            }

            .action-btn {
                width: 100%;
                text-align: center;
                padding: 0.8rem;
                font-size: 1.1rem;
                /* Larger touch targets */
            }
        }
    </style>
</head>

<body>
    <!-- SECURITY OVERLAY -->
    <div id="admin-login-overlay"
        style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div class="login-box">
            <h2>Admin Security</h2>
            <div style="margin-bottom:15px; text-align: left;">
                <label
                    style="display:block; color:var(--text-muted); font-size:0.9rem; margin-bottom:5px;">Password</label>
                <input type="password" id="admin-pass-input" class="login-input" placeholder="Enter Access Code">
            </div>
            <button onclick="checkAdmin()" class="login-btn">Access Panel</button>
            <p id="admin-error" style="color:#ef4444; font-size:0.9rem; margin-top:15px; display:none;">Access Denied
            </p>
        </div>
        <p style="margin-top:20px; color:rgba(255,255,255,0.3); font-size:0.8rem;">Rathna Home Foods Internal System</p>
    </div>

    <script>
        // Check Session immediately
        if (sessionStorage.getItem('RATHNA_ADMIN_SESSION') === 'true') {
            document.getElementById('admin-login-overlay').style.display = 'none';
        }

        function checkAdmin() {
            const pass = document.getElementById('admin-pass-input').value;
            // HARDCODED PASSWORD FOR DEMO - "admin123"
            if (pass === 'admin123') {
                sessionStorage.setItem('RATHNA_ADMIN_SESSION', 'true');
                document.getElementById('admin-login-overlay').style.display = 'none';
            } else {
                document.getElementById('admin-error').style.display = 'block';
            }
        }
    </script>

    <div class="admin-container">
        <header>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <!-- Optional Logo Icon -->
                <div style="font-size: 2rem;">üõ°Ô∏è</div>
                <h1>Admin Control</h1>
            </div>
            <a href="index.html" class="shop-link">Return to Shop ‚Üó</a>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('inventory', this)">Inventory Management</button>
            <button class="tab-btn" onclick="switchTab('orders', this)">Live Orders</button>
            <button class="tab-btn" onclick="switchTab('settings', this)">Settings</button>
        </div>

        <!-- Inventory Panel -->
        <div id="inventory" class="panel active">
            <div style="margin-bottom: 20px; text-align: right;">
                <button class="add-new-btn" onclick="openAddItemModal()">+ Add New Item</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Category</th>
                            <th>Stock Level</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-list">
                        <!-- Rendered by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add/Edit Item Modal -->
        <div id="add-item-modal" class="modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(5px); justify-content:center; align-items:center; z-index: 5000;">
            <div class="modal-content"
                style="padding:40px; border-radius:16px; width:450px; max-width:90%; position:relative; max-height: 90vh; overflow-y: auto;">
                <span onclick="closeAddItemModal()"
                    style="position:sticky; top:0; float:right; cursor:pointer; font-size:2rem; color: var(--gold-primary); line-height: 1; margin-top: -10px; margin-right: -10px; z-index: 10;">&times;</span>
                <h2 id="modal-title"
                    style="font-family:var(--font-heading); color:var(--gold-primary); margin-bottom:2rem; text-align:center; margin-top: 0;">
                    Add New Product</h2>

                <div style="display:flex; flex-direction:column; gap:15px;">
                    <input type="hidden" id="edit-item-id"> <!-- Hidden ID for edits -->

                    <input type="text" id="new-name" placeholder="Product Name" class="login-input" style="margin:0;">
                    <select id="new-category" class="login-input" style="margin:0;">
                        <option value="hot-items">Hot Items</option>
                        <option value="laddus">Laddus</option>
                        <option value="chikki-java">Chikki & Java</option>
                    </select>
                    <input type="text" id="new-qty" placeholder="Quantity/Unit (e.g. 500g)" class="login-input"
                        style="margin:0;">
                    <input type="number" id="new-price" placeholder="Price (‚Çπ)" class="login-input" style="margin:0;">
                    <input type="number" id="new-stock" placeholder="Initial Stock Count" class="login-input"
                        style="margin:0;">

                    <!-- Image Upload Section -->
                    <div
                        style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; border:1px dashed var(--glass-border);">
                        <label
                            style="display:block; color:var(--text-muted); font-size:0.9rem; margin-bottom:5px;">Product
                            Image</label>
                        <input type="file" id="new-image-file" accept="image/*" class="login-input"
                            style="padding:5px; margin:0;" onchange="previewImage()">
                        <input type="hidden" id="new-image-base64"> <!-- Stores the actual image data -->

                        <img id="image-preview" src=""
                            style="display:none; width:100%; height:150px; object-fit:contain; margin-top:10px; border-radius:4px; border:1px solid #333;">
                    </div>

                    <button onclick="handleSaveItem()" class="login-btn" style="margin-top:1rem;">Save Product</button>
                </div>
            </div>
        </div>

        <!-- Receipt Modal -->
        <div id="receipt-modal" class="modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); backdrop-filter:blur(5px); justify-content:center; align-items:center; z-index: 6000;">
            <div class="modal-content"
                style="padding:20px; border-radius:16px; max-width:90%; max-height:90vh; position:relative; text-align:center;">
                <span onclick="document.getElementById('receipt-modal').style.display='none'"
                    style="position:absolute; top:10px; right:20px; cursor:pointer; font-size:2rem; color:white;">&times;</span>
                <img id="receipt-image" src="" style="max-width:100%; max-height:80vh; border-radius:8px;">
                <p style="color:var(--gold-primary); margin-top:10px; font-family:var(--font-heading);">Payment Receipt
                </p>
            </div>
        </div>

        <!-- Orders Panel -->
        <div id="orders" class="panel">
            <div id="orders-list">
                <!-- Rendered by JS -->
            </div>
        </div>

        <!-- Settings Panel -->
        <div id="settings" class="panel">
            <div
                style="max-width:600px; margin:0 auto; background:rgba(255,255,255,0.03); padding:2rem; border-radius:12px; border:1px solid var(--glass-border);">
                <h2 style="color:var(--gold-primary); margin-bottom:1.5rem; font-family:var(--font-heading);">Delivery
                    Configuration</h2>

                <div style="margin-bottom:1.5rem;">
                    <label style="display:block; color:var(--text-muted); margin-bottom:0.5rem;">Free Delivery Above
                        (‚Çπ)</label>
                    <input type="number" id="setting-threshold" class="login-input" placeholder="e.g. 500">
                    <p style="font-size:0.8rem; color:rgba(255,255,255,0.4); margin-top:-10px;">Orders above this amount
                        will have free delivery.</p>
                </div>

                <div style="margin-bottom:2rem;">
                    <label style="display:block; color:var(--text-muted); margin-bottom:0.5rem;">Standard Delivery
                        Charge (‚Çπ)</label>
                    <input type="number" id="setting-charge" class="login-input" placeholder="e.g. 50">
                    <p style="font-size:0.8rem; color:rgba(255,255,255,0.4); margin-top:-10px;">Applied to orders below
                        the free threshold.</p>
                </div>

                <h3
                    style="color:var(--gold-primary); margin-bottom:1rem; font-family:var(--font-heading); border-top:1px dashed var(--glass-border); padding-top:1.5rem;">
                    Notification Setup</h3>

                <div style="margin-bottom:1.5rem;">
                    <label style="display:block; color:var(--text-muted); margin-bottom:0.5rem;">Owner Phone
                        (WhatsApp)</label>
                    <input type="text" id="setting-phone" class="login-input" placeholder="e.g. 918121178242">
                    <p style="font-size:0.8rem; color:rgba(255,255,255,0.4); margin-top:-10px;">Include country code
                        (e.g. 91) without +. Used for WhatsApp alerts.</p>
                </div>

                <div style="margin-bottom:1.5rem;">
                    <label style="display:block; color:var(--text-muted); margin-bottom:0.5rem;">Owner Email</label>
                    <input type="email" id="setting-email" class="login-input" placeholder="rathna@example.com">
                </div>

                <div style="background:rgba(0,0,0,0.2); padding:1rem; border-radius:8px; margin-bottom:2rem;">
                    <h4 style="color:var(--text-light); margin-bottom:10px;">EmailJS Configuration (Optional)</h4>
                    <input type="text" id="setting-ejs-service" class="login-input" placeholder="Service ID"
                        style="margin-bottom:0.5rem;">
                    <input type="text" id="setting-ejs-template" class="login-input" placeholder="Template ID"
                        style="margin-bottom:0.5rem;">
                    <input type="text" id="setting-ejs-key" class="login-input" placeholder="Public Key"
                        style="margin-bottom:0;">
                </div>

                <button onclick="saveSettings()" class="login-btn">Save Configuration</button>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        // Tab Switching
        function switchTab(tabName, btnElement) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            if (btnElement) btnElement.classList.add('active');

            if (tabName === 'inventory') renderInventory();
            if (tabName === 'orders') renderOrders();
            if (tabName === 'settings') renderSettings();
        }

        // --- Settings Logic ---
        function renderSettings() {
            const settings = window.RathnaApp.getSettings();
            document.getElementById('setting-threshold').value = settings.freeDeliveryThreshold;
            document.getElementById('setting-charge').value = settings.deliveryCharge;
            document.getElementById('setting-phone').value = settings.ownerPhone || '';
            document.getElementById('setting-email').value = settings.ownerEmail || '';
            document.getElementById('setting-ejs-service').value = settings.emailJsServiceId || '';
            document.getElementById('setting-ejs-template').value = settings.emailJsTemplateId || '';
            document.getElementById('setting-ejs-key').value = settings.emailJsPublicKey || '';
        }

        function saveSettings() {
            const threshold = parseFloat(document.getElementById('setting-threshold').value);
            const charge = parseFloat(document.getElementById('setting-charge').value);

            const ownerPhone = document.getElementById('setting-phone').value;
            const ownerEmail = document.getElementById('setting-email').value;
            const emailJsServiceId = document.getElementById('setting-ejs-service').value;
            const emailJsTemplateId = document.getElementById('setting-ejs-template').value;
            const emailJsPublicKey = document.getElementById('setting-ejs-key').value;

            if (isNaN(threshold) || isNaN(charge)) {
                window.RathnaApp.showToast("Please enter valid numbers for charges.", 'error');
                return;
            }

            window.RathnaApp.updateSettings({
                freeDeliveryThreshold: threshold,
                deliveryCharge: charge,
                ownerPhone,
                ownerEmail,
                emailJsServiceId,
                emailJsTemplateId,
                emailJsPublicKey
            });

            window.RathnaApp.showToast("Settings Saved Successfully!", 'success');
        }

        // --- Inventory Logic ---
        function renderInventory() {
            const inventory = window.RathnaApp.getInventory();
            const tbody = document.getElementById('inventory-list');
            tbody.innerHTML = '';

            inventory.forEach(item => {
                const tr = document.createElement('tr');
                let stockStatus = '';
                if (item.stock <= 0) stockStatus = 'color: #ef4444; font-weight:bold;';
                else if (item.stock < 10) stockStatus = 'color: #f59e0b;';

                const imgDisplay = item.image ? `<img src="${item.image}" style="width:40px; height:40px; border-radius:4px; object-fit:cover; vertical-align:middle; margin-right:10px;">` : '<span style="display:inline-block; width:40px; text-align:center; margin-right:10px;">üì¶</span>';

                tr.innerHTML = `
                    <td>
                        <div style="display:flex; align-items:center;">
                            ${imgDisplay}
                            <div>
                                <div style="font-weight:600; font-size:1.1rem;">${item.name}</div>
                                <div style="color:var(--text-muted); font-size:0.9rem;">${item.qty} ‚Ä¢ ‚Çπ${item.price}</div>
                            </div>
                        </div>
                    </td>
                    <td><span style="background:rgba(255,255,255,0.1); padding:4px 10px; border-radius:20px; font-size:0.85rem">${item.category}</span></td>
                    <td>
                        <input type="number" id="stock-${item.id}" value="${item.stock}" min="0" style="width:80px; text-align:center; ${stockStatus}" onchange="updateStock('${item.id}', this.value)">
                    </td>
                    <td>
                        <button class="action-btn save-btn" onclick="updateStock('${item.id}', document.getElementById('stock-${item.id}').value)">üíæ</button>
                        <button class="action-btn" style="background:rgba(212, 175, 55, 0.2); color:var(--gold-primary); border:1px solid rgba(212, 175, 55, 0.4);" onclick="openEditItemModal('${item.id}')">‚úé</button>
                        <button class="action-btn delete-btn" onclick="deleteItem('${item.id}')">üóë</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateStock(itemId, newVal) {
            window.RathnaApp.updateItemStock(itemId, newVal);
            const btn = document.querySelector(`button[onclick="updateStock('${itemId}', document.getElementById('stock-${itemId}').value)"]`);
            if (btn) {
                const originalText = btn.innerText;
                btn.innerText = "‚úì";
                setTimeout(() => btn.innerText = originalText, 1000);
            }
            window.RathnaApp.showToast("Stock updated", 'success');
        }

        function deleteItem(itemId) {
            if (confirm('Are you sure you want to delete this item?')) {
                if (window.RathnaApp.deleteItem(itemId)) {
                    renderInventory();
                    window.RathnaApp.showToast("Item deleted", 'info');
                } else {
                    alert('Failed to delete item.');
                }
            }
        }

        // --- Add/Edit Item Logic ---
        let editingItemId = null; // null if adding new, else ID string

        function openAddItemModal() {
            editingItemId = null;
            document.getElementById('modal-title').innerText = "Add New Product";
            // Clear inputs
            document.getElementById('new-name').value = "";
            document.getElementById('new-qty').value = "";
            document.getElementById('new-price').value = "";
            document.getElementById('new-stock').value = "";

            // Clear Image
            document.getElementById('new-image-file').value = "";
            document.getElementById('new-image-base64').value = "";
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('image-preview').src = "";

            document.getElementById('add-item-modal').style.display = 'flex';
        }

        function openEditItemModal(itemId) {
            const inventory = window.RathnaApp.getInventory();
            const item = inventory.find(i => i.id === itemId);
            if (!item) return;

            editingItemId = itemId; // Store ID we are editing
            document.getElementById('modal-title').innerText = "Edit Product";

            document.getElementById('new-name').value = item.name;
            document.getElementById('new-category').value = item.category;
            document.getElementById('new-qty').value = item.qty;
            document.getElementById('new-price').value = item.price;
            document.getElementById('new-stock').value = item.stock;

            // Load existing image into hidden base64 field and preview
            const currentImg = item.image || "";
            document.getElementById('new-image-base64').value = currentImg;
            document.getElementById('new-image-file').value = ""; // Reset file input as we can't prefill it

            const preview = document.getElementById('image-preview');
            if (currentImg) {
                preview.src = currentImg;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }

            document.getElementById('add-item-modal').style.display = 'flex';
        }

        function closeAddItemModal() {
            document.getElementById('add-item-modal').style.display = 'none';
        }

        function previewImage() {
            const file = document.getElementById('new-image-file').files[0];
            const preview = document.getElementById('image-preview');
            const hiddenInput = document.getElementById('new-image-base64');

            if (file) {
                const reader = new FileReader();
                reader.onloadend = function () {
                    preview.src = reader.result;
                    preview.style.display = 'block';
                    hiddenInput.value = reader.result; // Store Base64
                }
                reader.readAsDataURL(file);
            } else {
                // If they cancelled, do we keep old image? 
                // Mostly yes, but if they explicitly cleared it... 
                // For safety, let's not clear text unless they explicitly do something. 
                // But native file input doesn't really allow "clearing" easily by user without JS.
            }
        }

        function handleSaveItem() {
            const id = editingItemId;
            const name = document.getElementById('new-name').value;
            const category = document.getElementById('new-category').value;
            const qty = document.getElementById('new-qty').value;
            const price = document.getElementById('new-price').value;
            const stock = document.getElementById('new-stock').value;
            const image = document.getElementById('new-image-base64').value; // Get from hidden

            if (!name || !price) {
                window.RathnaApp.showToast("Please fill in Name and Price.", 'error');
                return;
            }

            const itemData = {
                name,
                category,
                qty: qty || '1 pc',
                price: parseFloat(price),
                stock: parseInt(stock || 0),
                image: image
            };

            if (id) {
                // EDIT EXISTING
                window.RathnaApp.updateItem(id, itemData);
                window.RathnaApp.showToast("Product updated successfully!", 'success');
            } else {
                // CREATE NEW
                window.RathnaApp.addNewItem(itemData);
                window.RathnaApp.showToast("New Item added successfully!", 'success');
            }

            closeAddItemModal();
            renderInventory(); // Refresh list
        }


        // --- Orders Logic ---
        function renderOrders() {
            const orders = window.RathnaApp.getOrders();
            const container = document.getElementById('orders-list');
            container.innerHTML = '';

            if (orders.length === 0) {
                container.innerHTML = '<p style="color:var(--text-muted); text-align:center;">No orders found.</p>';
                return;
            }

            orders.forEach(order => {
                const div = document.createElement('div');
                div.className = `order-card ${order.status}`; // Uses styles.css classes

                let itemsHtml = '';
                Object.values(order.items).forEach(item => {
                    itemsHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:5px; color:var(--text-light); text-align:left;">
                        <span>${item.quantity} x ${item.name}</span>
                        <span>‚Çπ${item.price * item.quantity}</span>
                    </div>`;
                });

                // Status Dropdown
                const statuses = ['pending', 'processing', 'out-for-delivery', 'delivered', 'confirmed', 'rejected'];
                let statusOptions = '';
                statuses.forEach(s => {
                    const label = s.replace(/-/g, ' ').toUpperCase();
                    const selected = order.status === s ? 'selected' : '';
                    statusOptions += `<option value="${s}" ${selected}>${label}</option>`;
                });

                // Receipt Button
                let receiptBtn = '';
                if (order.paymentScreenshot) {
                    receiptBtn = `<button onclick="viewReceipt('${order.paymentScreenshot}')" class="action-btn" style="background:#3b82f6; color:white; font-size:0.8rem; margin-right:10px;">üìÑ View Receipt</button>`;
                }

                div.innerHTML = `
                    <div class="order-header">
                        <span>#${order.id}</span>
                        <span style="font-size:0.8rem; opacity:0.7">${new Date(order.timestamp).toLocaleString()}</span>
                    </div>
                    <div style="text-align:left; margin-bottom:1rem;">
                        <span class="status-badge status-${order.status}">${order.status.replace(/-/g, ' ')}</span>
                        <h4 style="color:var(--gold-primary); margin-top:5px;">${order.customer.name}</h4>
                        <p style="color:var(--text-muted); font-size:0.9rem;">${order.customer.phone} <br> ${order.customer.address}</p>
                    </div>
                    <div style="background:rgba(0,0,0,0.2); padding:1rem; border-radius:8px; margin-bottom:1rem;">
                        ${itemsHtml}
                        <div style="border-top:1px dashed rgba(255,255,255,0.1); margin-top:10px; padding-top:10px; display:flex; justify-content:space-between; font-weight:bold; color:var(--gold-primary);">
                            <span>Total</span>
                            <span>‚Çπ${order.total}</span>
                        </div>
                        <div style="margin-top:5px; font-size:0.8rem; color:${order.payment === 'online-upi' ? '#34d399' : '#f59e0b'}; text-align:right;">
                            Paid via: ${order.payment.toUpperCase()}
                        </div>
                    </div>
                    <div style="display:flex; justify-content:flex-end; align-items:center; gap:10px;">
                        ${receiptBtn}
                        <select onchange="updateOrderStatus('${order.id}', this.value)" class="login-input" style="width:auto; margin:0; padding:5px; font-size:0.8rem;">
                            ${statusOptions}
                        </select>
                        <button class="action-btn delete-btn" onclick="deleteOrderPermanent('${order.id}')">Delete</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateOrderStatus(orderId, newStatus) {
            window.RathnaApp.updateOrderStatus(orderId, newStatus);
            window.RathnaApp.showToast(`Order status updated to ${newStatus}`, 'success');
            renderOrders(); // Refresh to update badge color
        }

        function deleteOrderPermanent(id) {
            if (confirm('Permanently delete this order record?')) {
                window.RathnaApp.deleteOrder(id);
                renderOrders();
                window.RathnaApp.showToast("Order Record Deleted", 'info');
            }
        }

        function viewReceipt(base64Img) {
            document.getElementById('receipt-image').src = base64Img;
            document.getElementById('receipt-modal').style.display = 'flex';
        }

        // Init
        renderInventory();
    </script>
</body>

</html>